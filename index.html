<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dynamic Classroom Schedule</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #f0f0f0; }
tr.locked { background: #eee; color: #888; }
tr.dragging { opacity: 0.5; }
input { width: 60px; text-align:center; }
button { padding: 8px 12px; margin-right: 10px; }
</style>
</head>
<body>

<h1>Dynamic Classroom Schedule</h1>

<label>Template: 
<select id="templateSelect"></select>
<button id="loadTemplate">Load</button>
<button id="saveTemplate">Save Current</button>
<input type="file" id="importFile">
<button id="exportTemplate">Export</button>
</label>

<table id="scheduleTable">
  <thead>
    <tr><th>Activity</th><th>Start Time</th><th>Duration (min)</th></tr>
  </thead>
  <tbody></tbody>
</table>

<button id="solveBtn">Solve Schedule</button>
<button id="resetBtn">Reset to Default</button>

<script>
// --- utils.js ---
window.utils = {
    deepCopy: obj => JSON.parse(JSON.stringify(obj)),
    minutesToTimeString: m => {
        const h=Math.floor(m/60), min=m%60;
        return `${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
    },
    timeStringToMinutes: s => {
        const [h,m]=s.split(':').map(Number);
        return h*60+m;
    }
};

// --- state.js ---
window.state = (function(){
    let currentSchedule=[], defaultSchedule=[];
    return {
        setDefaultSchedule: s=>{defaultSchedule=utils.deepCopy(s); currentSchedule=utils.deepCopy(s);},
        getCurrentSchedule: ()=>utils.deepCopy(currentSchedule),
        setCurrentSchedule: s=>{currentSchedule=utils.deepCopy(s); renderSchedule(currentSchedule);},
        resetToDefault: ()=>{currentSchedule=utils.deepCopy(defaultSchedule); renderSchedule(currentSchedule);}
    };
})();

// --- propagation.js ---
window.propagation = {
    propagateAll: function(schedule){
        for(let i=0;i<schedule.length-1;i++){
            let a=schedule[i], b=schedule[i+1];
            let overlap=(a.start+a.duration)-b.start;
            if(overlap>0 && !b.locked && b.flexible){
                b.duration=Math.max(b.minDuration,b.duration-overlap);
                overlap=(a.start+a.duration)-b.start;
            }
            if(overlap>0 && !b.locked) b.start+=overlap;
        }
    }
};

// --- template manager ---
function saveTemplate() {
    const name=prompt("Template name:");
    if(!name) return;
    const template={name: name, activities: window.state.getCurrentSchedule()};
    let templates=JSON.parse(localStorage.getItem('scheduleTemplates'))||[];
    templates.push(template);
    localStorage.setItem('scheduleTemplates', JSON.stringify(templates));
    refreshTemplateSelect();
}
function loadTemplate(index){
    const templates=JSON.parse(localStorage.getItem('scheduleTemplates'))||[];
    if(index<0||index>=templates.length) return;
    const t=templates[index];
    window.state.setDefaultSchedule(t.activities);
}
function refreshTemplateSelect(){
    const select=document.getElementById('templateSelect');
    select.innerHTML='';
    const templates=JSON.parse(localStorage.getItem('scheduleTemplates'))||[];
    templates.forEach((t,i)=>{
        const opt=document.createElement('option'); opt.value=i; opt.text=t.name; select.appendChild(opt);
    });
}
function exportTemplate(){
    const index=document.getElementById('templateSelect').value;
    const templates=JSON.parse(localStorage.getItem('scheduleTemplates'))||[];
    if(!templates[index]) return;
    const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(templates[index]));
    const a=document.createElement('a'); a.href=dataStr; a.download=templates[index].name+".json";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function importTemplate(file){
    const reader=new FileReader();
    reader.onload=function(e){
        const t=JSON.parse(e.target.result);
        let templates=JSON.parse(localStorage.getItem('scheduleTemplates'))||[];
        templates.push(t); localStorage.setItem('scheduleTemplates', JSON.stringify(templates));
        refreshTemplateSelect();
    }
    reader.readAsText(file);
}

// --- default schedule ---
const defaultSchedule=[
    {name:'Arrival', start:480, duration:60, minDuration:50, maxDuration:70, flexible:true},
    {name:'Meeting', start:540, duration:30, minDuration:30, maxDuration:30, flexible:false},
    {name:'Playground', start:570, duration:60, minDuration:50, maxDuration:70, flexible:true},
    {name:'Play', start:630, duration:60, minDuration:60, maxDuration:60, flexible:false},
    {name:'Lunch', start:690, duration:30, minDuration:20, maxDuration:40, flexible:true},
    {name:'Goodbye', start:720, duration:15, minDuration:15, maxDuration:15, flexible:false}
];
window.state.setDefaultSchedule(defaultSchedule);

// --- rendering ---
function renderSchedule(schedule){
    const tbody=document.querySelector('#scheduleTable tbody');
    tbody.innerHTML='';
    schedule.forEach((act,i)=>{
        const row=document.createElement('tr');
        if(act.locked) row.classList.add('locked');
        row.setAttribute('draggable',!act.locked);
        row.dataset.index=i;
        row.innerHTML=`<td>${act.name}</td>
                       <td><input type="time" step="300" value="${utils.minutesToTimeString(act.start)}" data-index="${i}" class="start"></td>
                       <td><input type="number" step="5" min="${act.minDuration}" max="${act.maxDuration}" value="${act.duration}" data-index="${i}" class="duration"></td>`;
        tbody.appendChild(row);
    });

    // change handlers
    document.querySelectorAll('.start').forEach(input=>{
        input.addEventListener('change', e=>{
            const i=parseInt(e.target.dataset.index), val=utils.timeStringToMinutes(e.target.value);
            const schedule=window.state.getCurrentSchedule();
            if(!schedule[i].locked){ schedule[i].start=val; window.propagation.propagateAll(schedule); window.state.setCurrentSchedule(schedule); }
        });
    });
    document.querySelectorAll('.duration').forEach(input=>{
        input.addEventListener('change', e=>{
            const i=parseInt(e.target.dataset.index), val=parseInt(e.target.value);
            const schedule=window.state.getCurrentSchedule();
            if(!schedule[i].locked && schedule[i].flexible){ schedule[i].duration=val; window.propagation.propagateAll(schedule); window.state.setCurrentSchedule(schedule); }
        });
    });

    // drag-and-drop
    let dragged=null;
    tbody.querySelectorAll('tr').forEach(row=>{
        row.addEventListener('dragstart', e=>{ dragged=row; row.classList.add('dragging'); });
        row.addEventListener('dragend', e=>{ dragged=null; row.classList.remove('dragging'); });
        row.addEventListener('dragover', e=>{ e.preventDefault(); });
        row.addEventListener('drop', e=>{
            e.preventDefault();
            if(dragged && dragged!==row){
                const schedule=window.state.getCurrentSchedule();
                const from=parseInt(dragged.dataset.index);
                const to=parseInt(row.dataset.index);
                const moved=schedule.splice(from,1)[0];
                schedule.splice(to,0,moved);
                moved.start=to===0?schedule[0].start:schedule[to-1].start+schedule[to-1].duration;
                window.propagation.propagateAll(schedule);
                window.state.setCurrentSchedule(schedule);
            }
        });
    });
}

// --- initial render ---
renderSchedule(window.state.getCurrentSchedule());
refreshTemplateSelect();

// --- button handlers ---
document.getElementById('solveBtn').addEventListener('click', ()=>window.propagation.propagateAll(window.state.getCurrentSchedule()));
document.getElementById('resetBtn').addEventListener('click', ()=>window.state.resetToDefault());
document.getElementById('saveTemplate').addEventListener('click', saveTemplate);
document.getElementById('loadTemplate').addEventListener('click', ()=>loadTemplate(document.getElementById('templateSelect').value));
document.getElementById('exportTemplate').addEventListener('click', exportTemplate);
document.getElementById('importFile').addEventListener('change', e=>importTemplate(e.target.files[0]));

</script>
</body>
</html>
