<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dynamic Classroom Schedule - Drag & Drop</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  tr.locked { background: #eee; color: #888; cursor: default; }
  tr.dragging { opacity: 0.5; }
  input { width: 50px; }
  button { padding: 8px 12px; margin-right: 10px; }
</style>
</head>
<body>

<h1>Dynamic Classroom Schedule</h1>

<table id="scheduleTable">
  <thead>
    <tr><th>Activity</th><th>Start Time</th><th>Duration (min)</th></tr>
  </thead>
  <tbody></tbody>
</table>

<button id="solveBtn">Solve Schedule</button>
<button id="resetBtn">Reset to Default</button>

<script>
// --- utils.js ---
window.utils = {
    deepCopy: obj => JSON.parse(JSON.stringify(obj)),
    minutesToTimeString: m => { const h=Math.floor(m/60), min=m%60; return `${h}:${min.toString().padStart(2,'0')}`; },
    timeStringToMinutes: s => { const [h,m]=s.split(':').map(Number); return h*60+m; }
};

// --- state.js ---
window.state = (function(){
    let currentSchedule=[], defaultSchedule=[];
    return {
        setDefaultSchedule: s=>{defaultSchedule=utils.deepCopy(s); currentSchedule=utils.deepCopy(s);},
        getCurrentSchedule: ()=>utils.deepCopy(currentSchedule),
        setCurrentSchedule: s=>{currentSchedule=utils.deepCopy(s);},
        resetToDefault: ()=>{currentSchedule=utils.deepCopy(defaultSchedule);}
    };
})();

// --- propagation.js ---
window.propagation = {
    propagateAll: function(schedule, dayStart, dayEnd){
        for(let i=0;i<schedule.length-1;i++){
            let a=schedule[i], b=schedule[i+1];
            let overlap=(a.start+a.duration)-b.start;
            if(overlap>0 && !b.locked && b.flexible){ b.duration=Math.max(b.minDuration,b.duration-overlap); overlap=(a.start+a.duration)-b.start; }
            if(overlap>0 && !b.locked) b.start+=overlap;
        }
    }
};

// --- apply.js ---
window.apply = {
    applySchedule: function(schedule){ window.state.setCurrentSchedule(schedule); renderSchedule(schedule); }
};

// --- solver.js ---
window.solver = { solveSchedule: function(){
    const schedule=window.state.getCurrentSchedule();
    const dayStart=480, dayEnd=12*60+15;
    window.propagation.propagateAll(schedule, dayStart, dayEnd);
    window.apply.applySchedule(schedule);
}};

// --- Default schedule ---
const defaultSchedule=[
    {name:'Arrival', start:480, duration:60, minDuration:50, maxDuration:70, flexible:true},
    {name:'Meeting', start:540, duration:30, minDuration:30, maxDuration:30, flexible:false},
    {name:'Playground', start:570, duration:60, minDuration:50, maxDuration:70, flexible:true},
    {name:'Play', start:630, duration:60, minDuration:60, maxDuration:60, flexible:false},
    {name:'Lunch', start:690, duration:30, minDuration:20, maxDuration:40, flexible:true},
    {name:'Goodbye', start:720, duration:15, minDuration:15, maxDuration:15, flexible:false}
];
window.state.setDefaultSchedule(defaultSchedule);

// --- Rendering ---
function renderSchedule(schedule){
    const tbody=document.querySelector('#scheduleTable tbody');
    tbody.innerHTML='';
    schedule.forEach((act,i)=>{
        const row=document.createElement('tr');
        if(act.locked) row.classList.add('locked');
        row.setAttribute('draggable',!act.locked);
        row.dataset.index=i;
        row.innerHTML=`<td>${act.name}</td>
                       <td><input type="number" value="${act.start}" data-index="${i}" class="start"></td>
                       <td><input type="number" value="${act.duration}" data-index="${i}" class="duration"></td>`;
        tbody.appendChild(row);
    });

    // Input change handlers
    document.querySelectorAll('.start').forEach(input=>{
        input.addEventListener('change', e=>{
            const i=parseInt(e.target.dataset.index);
            const val=parseInt(e.target.value);
            const schedule=window.state.getCurrentSchedule();
            if(!schedule[i].locked){ schedule[i].start=val; window.state.setCurrentSchedule(schedule); }
        });
    });
    document.querySelectorAll('.duration').forEach(input=>{
        input.addEventListener('change', e=>{
            const i=parseInt(e.target.dataset.index);
            const val=parseInt(e.target.value);
            const schedule=window.state.getCurrentSchedule();
            if(!schedule[i].locked && schedule[i].flexible){ schedule[i].duration=val; window.state.setCurrentSchedule(schedule); }
        });
    });

    // Drag-and-drop handlers
    let dragged=null;
    tbody.querySelectorAll('tr').forEach(row=>{
        row.addEventListener('dragstart', e=>{ dragged=row; row.classList.add('dragging'); });
        row.addEventListener('dragend', e=>{ dragged=null; row.classList.remove('dragging'); });
        row.addEventListener('dragover', e=>{ e.preventDefault(); });
        row.addEventListener('drop', e=>{
            e.preventDefault();
            if(dragged && dragged!==row){
                const schedule=window.state.getCurrentSchedule();
                const from=parseInt(dragged.dataset.index);
                const to=parseInt(row.dataset.index);
                const moved=schedule.splice(from,1)[0];
                schedule.splice(to,0,moved);
                // Set start time to match new position
                moved.start = to===0 ? schedule[0].start : schedule[to-1].start + schedule[to-1].duration;
                window.propagation.propagateAll(schedule,480,12*60+15);
                window.state.setCurrentSchedule(schedule);
                renderSchedule(schedule);
            }
        });
    });
}

// --- Initial render ---
renderSchedule(window.state.getCurrentSchedule());

// --- Button handlers ---
document.getElementById('solveBtn').addEventListener('click', ()=>window.solver.solveSchedule());
document.getElementById('resetBtn').addEventListener('click', ()=>{
    window.state.resetToDefault();
    renderSchedule(window.state.getCurrentSchedule());
});
</script>

</body>
</html>
